




<style>
  div#users-contain { width: 350px; margin: 20px 0; }
  div#users-contain table { margin: 1em 0; border-collapse: collapse; width: 100%; }
  div#users-contain table td, div#users-contain table th { border: 1px solid #eee; padding: .6em 10px; text-align: left; }
  .ui-dialog .ui-state-error { padding: .3em; }
  .validateTips { border: 1px solid transparent; padding: 0.3em; }
</style>

<div id="dialog-form" title="Edit flight" style="display: none">
  <p class="validateTips">All form fields are required.</p>

  <form>
  <fieldset>
    <label for="pilot">Pilot</label>
    <input type="text" name="pilot" id="pilot" class="text ui-widget-content ui-corner-all" />

  </fieldset>
  </form>
</div>


<script>
$(function() {

  var pilot = $("#pilot" );

  pilot.autocomplete({
      source: function( request, response ) {
        $.ajax({
          url: "/pilots",
          dataType: "json",
          data: {
            view: 'combo',
            flt: 'combo',
            sort: 'person.last_name,person.first_name',
            search: request.term,
            limit: 10
          },
          success: function(data) {
            response( $.map(data, function(item) {
              return {
                label: item.person.name,
                value: item.id
              }
            }));
          }
        });
      },
      minLength: 2,
/*      select: function( event, ui ) {
        log( ui.item ?
          "Selected: " + ui.item.label :
          "Nothing selected, input was " + this.value);
      },*/
      open: function() {
        $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
      },
      close: function() {
        $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
      }
    });


  allFields = $( [] ).add( name ),
  tips = $( ".validateTips" );

  function updateTips( t ) {
    tips
      .text( t )
      .addClass( "ui-state-highlight" );
    setTimeout(function() {
      tips.removeClass( "ui-state-highlight", 1500 );
    }, 500 );
  }

  function checkLength( o, n, min, max ) {
    if ( o.val().length > max || o.val().length < min ) {
      o.addClass( "ui-state-error" );
      updateTips( "Length of " + n + " must be between " +
        min + " and " + max + "." );
      return false;
    } else {
      return true;
    }
  }

  function checkRegexp( o, regexp, n ) {
    if ( !( regexp.test( o.val() ) ) ) {
      o.addClass( "ui-state-error" );
      updateTips( n );
      return false;
    } else {
      return true;
    }
  }

  
  $( "#dialog-form" ).dialog({
    autoOpen: false,
    height: 500,
    width: 500,
    modal: true,
    buttons: {
      "Modify": function() {
        var bValid = true;
        allFields.removeClass( "ui-state-error" );

        bValid = bValid && checkLength( name, "username", 3, 16 );

        bValid = bValid && checkRegexp( name, /^[a-z]([0-9a-z_])+$/i, "Username may consist of a-z, 0-9, underscores, begin with a letter." );
        // From jquery.validate.js (by joern), contributed by Scott Gonzalez: http://projects.scottsplayground.com/email_address_validation/
        bValid = bValid && checkRegexp( email, /^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i, "eg. ui@jquery.com" );
        bValid = bValid && checkRegexp( password, /^([0-9a-zA-Z])+$/, "Password field only allow : a-z 0-9" );

        if ( bValid ) {
          $( "#users tbody" ).append( "<tr>" +
            "<td>" + name.val() + "</td>" + 
            "<td>" + email.val() + "</td>" + 
            "<td>" + password.val() + "</td>" +
          "</tr>" ); 
          $( this ).dialog( "close" );
        }
      },
      Cancel: function() {
        $( this ).dialog( "close" );
      }
    },
    close: function() {
      allFields.val( "" ).removeClass( "ui-state-error" );
    }
  });

});
</script>







<div id="list_div" style="display: none"></div>
<div id="info_div">
<% if authenticated_admin? %>
  <div class="edit_box">
  <%= link_to_function image_tag('action_edit.png', :alt => 'Edit...'),
            'jQuery("#dialog-form").dialog("open")' %>

  <%= link_to image_tag('action_delete.png', :alt => 'Delete...'),
         flight_path(@target),
         :method => :delete,
         :confirm => 'Sei sicurisssimo?',
         :remote => true
 %>
  </div>
<% end %>

<div class="box flight_info">
<table class="standard flight_info">
  <tr>
    <th>Aliante</th>
    <td class="registration">
      <%= link_to(@target.plane.registration, @target.plane) %> -
      <%= link_to(@target.plane.plane_type.name, @target.plane.plane_type) %>
    </td>
  </tr>
  <tr>
    <th>Pilota</th>
    <td class="pilot">
        <%= link_to(@target.pilot.person.name, @target.pilot) %>
    </td>
  </tr>
  <tr>
    <th>Decollo</th>
    <td class="takoff">
      <%=h l(@target.takeoff_time) %>
    </td>
  </tr>
  <tr>
    <th>Durata</th>
    <td class="duration">
      <%=h fmt_duration(@target.duration) %>
    </td>
  </tr>
<% if @target.has_igc_file? %>
  <tr>
    <th>Scarica</th>
    <td>
      <%= link_to(image_tag('show_with_seeyou.jpg',
                      :alt => 'Logo SeeYou',
                      :title => 'Apri con SeeYou'),
                 flight_path(@target, :format => 'igc')) -%>
      <%= link_to(image_tag('show_with_google_earth.png',
                      :alt => 'Logo Google Earth',
                      :title => 'Apri con Google Earth'),
                 flight_path(@target, :format => 'kml')) -%>
      <%= link_to(image_tag('download_gpx.png',
                      :alt => 'Logo GPX',
                      :title => 'Scarica in formato GPX'),
                 flight_path(@target, :format => 'gpx')) -%>
    </td>
  </tr>
<% end %>
</table>
</div>

<% @target.flight_tags.each do |r| %>
  <% if r.tag.symbol.to_sym == :csvva_2011 %>
    <%= render :partial => 'flights/csvva/tag', :object => r %>
  <% end %>
<% end %>

<% if @target.encoded_polyline && @target.encoded_polyline.size > 0 %>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>

<div id="map_container" class="map_container" style="width: 100%; height: 500px;">
  <div id="map" class="map" style="width: 100%; height: 100%;"></div>
</div>
<%= javascript_tag do -%>

$(document).ready(function() {

  var map = new google.maps.Map(document.getElementById("map"), {
    zoom: 8,
    center: google.maps.LatLng(0, 0),
    mapTypeId: google.maps.MapTypeId.TERRAIN
  });

  var path = google.maps.geometry.encoding.decodePath("<%= @target.encoded_polyline %>");

  var bounds = new google.maps.LatLngBounds();
  for (var i = 0; i < path.length; i++) {
    bounds.extend(path[i]);
  }

  poly = new google.maps.Polyline({
    path: path,
    strokeColor: '#FF0000',
    strokeOpacity: 1.0,
    strokeWeight: 3
  });

  poly.setMap(map);

  map.fitBounds(bounds);
});

<% end %>
<% end %>

</div>
