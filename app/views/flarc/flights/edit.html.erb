<div id="flight-submit" class="row-fluid">
  <div id="flight-submit-container" class="span8">

    <div id="flight-submit-dialog">
      <%= render :partial => 'flarc/flights/editor' %>
    </div>
  </div>

  <div class="span4">
    <div id="upload_dialog_map"></div>
  </div>
</div>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&sensor=false"></script>

<script type="text/javascript">
//<![CDATA[

function load_record(record)
{
  cships = {};
  $.each(record.championship_flights, function(index, value) {
    cships[value._type] = value;
  });

  cid = cships['Flarc::Championship::Flight::Cid2012'];
  if (cid) {
    $('#flight-data-form input[name=cid_distance]').val(cid.distance / 1000);
    $('#flight-data-form select[name=cid_task_type]').selectOptions(cid.data.task_type);
    $('#flight-data-form select[name=cid_task_eval]').selectOptions(cid.data.task_eval);
  }

  $('#flight-data-form input[name=notes]').val(record.notes);

  pilot_changed(record.pilot);
  plane_changed(record.plane);

//  $('#flight-data-form input[name=]').val(record.);
//  $('#flight-data-form input[name=]').val(record.);
//  $('#flight-data-form input[name=]').val(record.);
//  $('#flight-data-form input[name=]').val(record.);
//  $('#flight-data-form input[name=]').val(record.);
}

$(function() {

  map = new google.maps.Map(document.getElementById('upload_dialog_map'), {
    zoom: 5,
    center: new google.maps.LatLng(42, 13),
    mapTypeId: google.maps.MapTypeId.TERRAIN
  });

  load_record(<%= @target_json.html_safe %>);
  $('#flight-data-form').fadeIn(600, 'swing');

  $('#flight-data-form .btn-primary').click(function() {
    req = {};
    req.igc_tmp_file_id = $('#igc_tmp_file_id').val();

    req.flight = {};
    req.flight.plane_type_configuration_id = $('#plane_type_configuration_id').val();
    req.flight.championship_flights = [];
    req.flight.pilot_id = $('#pilot_id').val();
    req.flight.plane_id = $('#plane_id').val();
    req.flight.notes_public = $('#notes_public').val();

    if (!req.flight.plane_id) {
      req.plane = {};
      req.plane.registration = $('#plane').val().toUpperCase();
      req.plane.plane_type_id = $('#plane_type_id').val();
    }

    if ($('#cid_member').prop('checked')) {
      var cid = {};
      cid._type = 'Championship::Flight::Cid2012';
      cid.distance  = parseFloat($('#cid_distance').val().replace(/,/, '.')) * 1000;
      cid.cid_ranking = $('#cid_ranking').val();
      cid.task_eval = $('#cid_task_eval').val();
      cid.task_type = $('#cid_task_type').val();
      cid.task_completed = $('#cid_task_completed').val() == 'true';
      req.flight.championship_flights.push(cid)
    }

    if ($('#csvva_member').prop('checked')) {
      var csvva = {};
      csvva._type = 'Championship::Flight::Csvva2012';
      csvva.distance  = parseFloat($('#csvva_distance').val().replace(/,/, '.')) * 1000;
      req.flight.championship_flights.push(csvva);
    }

    $('#flight-data-form .form-actions .alert').remove();
    $('#flight-data-form .form-actions .btn-primary').spinner({ position: 'center', hide: true });

    $.ajax({
      url: '/flarc/flights/submit',
      dataType: 'json',
      type: 'POST',
      contentType: 'application/json; charset=utf-8',
      data: JSON.stringify(req),
      success: function(data) {
        window.location = '/flarc/flights/' + data.id;
      },
      error: function(data) {
        $('#flight-data-form .form-actions .btn-primary').spinner('remove');

        var ex = $.parseJSON(data.responseText);
        var msg = '';

        var field_names = {
          'championship_flights.cid_ranking': 'Classifica CID',
          'championship_flights.task_eval': 'Valutazione Tema CID',
          'championship_flights.task_type': 'Tipo di tema CID',
          'championship_flights.task_completed': 'Tema CID completato',
          'championship_flights.distance': 'Distanza',
        };

        $.each(ex.per_field_msgs, function(k, v) {
           msg += '<li>Il campo <strong>' + field_names[k] + '</strong> ' + v + '</li>';
        });

        $('#flight-data-form .form-actions').append(
          '<div class="alert alert-error">' + ex.short_msg + '<br />' +
            '<ul>' + msg + '</ul>' +
          '</div>');
      }
    });

    return false;
  });
});

//]]>
</script>
